
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>The Simulation &#8212; RecoEdge 0 documentation</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/pydata-sphinx-theme.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="FL Simulation" href="Tutorial-Part-3-simulating_fl_cycle.html" />
    <link rel="prev" title="What is Federated Learning?" href="Tutorial-Part-1-introduction_to_fl.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../index.html">
<p class="title">RecoEdge</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../getting_started.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="index.html">
  Tutorials
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Tutorial-Part-1-introduction_to_fl.html">
   What is Federated Learning?
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   The Simulation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Tutorial-Part-3-simulating_fl_cycle.html">
   FL Simulation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Tutorial-Part-4-deployment.html">
   FL Deployment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Tutorial-Part-5-local_training.html">
   On-device Training
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Tutorial-Part-6-customization.html">
   Customization
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   The Simulation
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-definition">
   Model Definition
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hooking-the-registry">
   Hooking the registry
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#standard-training">
   Standard Training
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#federated-training">
   Federated Training
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <ul class="simple">
<li><p><a class="reference external" href="#the-simulation">The Simulation</a></p></li>
<li><p><a class="reference external" href="#model-definition">Model Definition</a></p></li>
<li><p><a class="reference external" href="#hooking-the-registry">Hooking the registry</a></p></li>
<li><p><a class="reference external" href="#standard-training">Standard Training</a></p></li>
</ul>
<section id="the-simulation">
<h1>The Simulation<a class="headerlink" href="#the-simulation" title="Permalink to this headline">¶</a></h1>
<p>Before we put a code into production we need to evaluate the models and
run benchmarks to get the expected accuracy gains.</p>
<p>There is a <a class="reference external" href="https://github.com/NimbleEdge/RecoEdge">simulator</a>
created by NimbleEdge exactly for this purpose.</p>
<ul class="simple">
<li><p>The FL simulator is designed in a way to make the architecture as
close to real world deployments as possible.</p></li>
<li><p>You can simulate both the normal ML training and FL training with the
simulator.</p></li>
<li><p>The design is scalable to hit 10000+ workers running in the
simulation.</p></li>
</ul>
<p>Let’s take an example of FB AI’s
<a class="reference external" href="https://arxiv.org/abs/1906.00091">DLRM</a>. This is one of the standard
baselines for recommendation engines. We will be training this model on
<a class="reference external" href="https://www.kaggle.com/c/criteo-display-ad-challenge">Kaggle Criteo Ads
Data</a>.</p>
</section>
<section id="model-definition">
<h1>Model Definition<a class="headerlink" href="#model-definition" title="Permalink to this headline">¶</a></h1>
<p>All the model descriptions go into
<a class="reference external" href="https://github.com/NimbleEdge/RecoEdge/tree/main/fedrec/modules">fedrec/modules</a>.
You can add your own folder of models as well and hook the registry with
it.</p>
<p>We will create a file dlrm.py and write its implementation in standard
pytorch code.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>


<span class="k">class</span> <span class="nc">DLRM_Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">arg3</span><span class="p">):</span>
        <span class="c1"># Your model description comes here.</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
        <span class="c1"># process inputs</span>
        <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
<p>To see the real implementation of DLRM, please check out the <a class="reference external" href="../fedrec/modules/dlrm.py">dlrm
implementation in the repository</a></p>
</section>
<section id="hooking-the-registry">
<h1>Hooking the registry<a class="headerlink" href="#hooking-the-registry" title="Permalink to this headline">¶</a></h1>
<p>The simulator makes it easy to experiment with different model
architectures, hyper parameters, optimizers and other components of an
ML pipeline.</p>
<p>We define a <a class="reference external" href="../fedrec/utilities/registry.py">registry class</a> which
records all the model definitions, optimizers and attaches a
configuration file to the top.</p>
<p>For all your experiments simply define the config file and you are done.</p>
<p>In our DLRM model description, we record it in the registry by
annotating it with <code class="docutils literal notranslate"><span class="pre">&#64;registry.load(&lt;Class</span> <span class="pre">Type&gt;,</span> <span class="pre">&lt;Name&gt;)</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">fedrec.utilities</span> <span class="kn">import</span> <span class="n">registry</span>

<span class="nd">@registry</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span><span class="s1">&#39;dlrm&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DLRM_Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">arg3</span><span class="p">):</span>
        <span class="c1"># Your model description comes here.</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
        <span class="c1"># process inputs</span>
        <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
<p>Now create a <a class="reference external" href="../configs/dlrm.yml">config.yml</a> file to pass the
arguments and hyper parameters.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="c1"># The &lt;Class Type&gt; annotated in registry</span><span class="w"></span>
<span class="w">    </span><span class="nt">name </span><span class="p">:</span><span class="w"> </span><span class="s">&#39;dlrm&#39;</span><span class="w"> </span><span class="c1"># The unique identifier key</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="standard-training">
<h1>Standard Training<a class="headerlink" href="#standard-training" title="Permalink to this headline">¶</a></h1>
<p>Training your model in the normal non-FL settting requires you to write
the implementations for <code class="docutils literal notranslate"><span class="pre">train</span></code> and <code class="docutils literal notranslate"><span class="pre">test</span></code> methods. You can also
implement <code class="docutils literal notranslate"><span class="pre">validate</span></code> method if you want and all these methods will
automatically be serialized into FL plans when we move into FL
deployment.</p>
<p>The <a class="reference external" href="../fedrec/trainers/base_trainer.py">BaseTrainer</a> abstracts away
the basic methods needed to implemented.</p>
<p>Simply subclass the <code class="docutils literal notranslate"><span class="pre">BaseTrainer</span></code> and create your own trainer object.
We will call this DLRMTrainer</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@registry</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;trainer&#39;</span><span class="p">,</span> <span class="s1">&#39;dlrm&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DLRMTrainer</span><span class="p">(</span><span class="n">BaseTrainer</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">config_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
            <span class="n">train_config</span><span class="p">:</span> <span class="n">DLRMTrainConfig</span><span class="p">,</span>
            <span class="n">logger</span><span class="p">:</span> <span class="n">BaseLogger</span><span class="p">,</span>
            <span class="n">model_preproc</span><span class="p">:</span> <span class="n">PreProcessor</span><span class="p">,)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">train_config</span> <span class="o">=</span> <span class="n">train_config</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config_dict</span><span class="p">,</span> <span class="n">train_config</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">model_preproc</span><span class="p">)</span>
</pre></div>
</div>
<p>Next implement the data loaders. These are standard PyTorch dataloaders
and return them in the Trainer class.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">dataloaders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">train_data_loader</span><span class="p">,</span>
            <span class="s1">&#39;train_eval&#39;</span><span class="p">:</span> <span class="n">train_eval_data_loader</span><span class="p">,</span>
            <span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">val_data_loader</span>
        <span class="p">}</span>
</pre></div>
</div>
<p>Define the train and test methods of <code class="docutils literal notranslate"><span class="pre">BaseTrainer</span></code> in <code class="docutils literal notranslate"><span class="pre">DLRMTrainer</span></code>.</p>
<p>With this you are ready to train your model. Till now we have been doing
what you usually do to train your ML models. We have been writing
standard PyTorch code and developing our ML pipeline.</p>
</section>
<section id="federated-training">
<h1>Federated Training<a class="headerlink" href="#federated-training" title="Permalink to this headline">¶</a></h1>
<p>Now we will simulate DLRM in federated setting. Create data split to
mimic your users. We use Drichlet sampling for creating non-IID datasets
for the model.</p>
<p>Implement your own federated learning algorithm. In the demo we are
using Federated Averaging. You just need to sub-class
<a class="reference external" href="fedrec/federated_worker.py">FederatedWorker</a> and implement <code class="docutils literal notranslate"><span class="pre">run()</span></code>
method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@registry</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;fl_algo&#39;</span><span class="p">,</span> <span class="s1">&#39;fed_avg&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">FedAvgWorker</span><span class="p">(</span><span class="n">FederatedWorker</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            `Run` function updates the local model.</span>
<span class="sd">            Implement this method to determine how the roles interact with each other to determine the final updated model.</span>
<span class="sd">            For example a worker which has both the `aggregator` and `trainer` roles might first train locally then run discounted `aggregate()` to get the fianl update model</span>


<span class="sd">            In the following example,</span>
<span class="sd">            1. Aggregator requests models from the trainers before aggregating and updating its model.</span>
<span class="sd">            2. Trainer responds to aggregators&#39; requests after updating its own model by local training.</span>

<span class="sd">            Since standard FL requires force updates from central entity before each cycle, trainers always start with global model/aggregator&#39;s model</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">role</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roles</span><span class="p">,</span> <span class="n">InvalidStateError</span><span class="p">(</span><span class="s2">&quot;unknown role for worker&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;aggregator&#39;</span><span class="p">:</span>
            <span class="n">neighbours</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_models_suspendable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_neighbours</span><span class="p">())</span>
            <span class="n">weighted_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_model</span><span class="p">(</span><span class="n">weighted_params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;trainer&#39;</span><span class="p">:</span>
            <span class="c1"># central server in this case</span>
            <span class="n">aggregators</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_neighbours</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">global_models</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_models_suspendable</span><span class="p">(</span><span class="n">aggregators</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_model</span><span class="p">(</span><span class="n">global_models</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">model_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">persistent_storage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">round_idx</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Your aggregation strategy</span>
    <span class="k">def</span> <span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neighbour_ids</span><span class="p">):</span>
        <span class="n">model_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_neighbours</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">sample_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_neighbours</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">neighbour_ids</span>
        <span class="p">]</span>
        <span class="p">(</span><span class="n">num0</span><span class="p">,</span> <span class="n">averaged_params</span><span class="p">)</span> <span class="o">=</span> <span class="n">model_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">averaged_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_list</span><span class="p">)):</span>
                <span class="n">local_sample_number</span><span class="p">,</span> <span class="n">local_model_params</span> <span class="o">=</span> <span class="n">model_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">local_sample_number</span> <span class="o">/</span> <span class="n">training_num</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">averaged_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_model_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">averaged_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">local_model_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span>

        <span class="k">return</span> <span class="n">averaged_params</span>

    <span class="c1"># Your sampling strategy</span>
    <span class="k">def</span> <span class="nf">sample_neighbours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">round_idx</span><span class="p">,</span> <span class="n">client_num_per_round</span><span class="p">):</span>
        <span class="n">num_neighbours</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_neighbours</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_neighbours</span> <span class="o">==</span> <span class="n">client_num_per_round</span><span class="p">:</span>
            <span class="n">selected_neighbours</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">neighbour</span> <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_neighbours</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">RandomContext</span><span class="p">(</span><span class="n">round_idx</span><span class="p">):</span>
                <span class="n">selected_neighbours</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_neighbours</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">client_num_per_round</span><span class="p">,</span> <span class="n">num_neighbours</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;worker_indexes = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">selected_neighbours</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">selected_neighbours</span>
</pre></div>
</div>
<p>Begin FL simulation by</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mpirun -np <span class="m">20</span> python -m mpi4py.futures train_fl.py --num_workers <span class="m">1000</span>.
</pre></div>
</div>
<p>In the <a class="reference external" href="./Tutorial-Part-3-simulating_fl_cycle.md">next section</a> we
will see how easy it is to convert the normal ML pipeline into an FL
pipeline.</p>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="Tutorial-Part-1-introduction_to_fl.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">What is Federated Learning?</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="Tutorial-Part-3-simulating_fl_cycle.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">FL Simulation</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, NimbleEdge Community.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>